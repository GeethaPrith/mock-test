<div class="section-bar d-flex justify-content-between align-items-center" *ngIf="test && test.length">
  <div class="d-flex align-items-center">
    <div class="section-bar-label">Sections</div>
    <div class="section-bar-links ms-3 d-flex align-items-center">
      <a class="section-link" *ngFor="let section of test; let idx = index" (click)="switchSection(idx)" [class.active-section]="currentSectionIndex === idx">{{ section.title }}</a>
    </div>
  </div>
  <div class="section-bar-timer me-3">
    <span class="time">Time Left: {{ timer | date:'mm:ss' }}</span>
  </div>
</div>
<div class="row" *ngIf="test && test.length">
  <div class="question-card-container d-flex flex-column justify-content-between">
    <div>
      <h4>Q{{ currentQuestionIndex + 1 }}. {{ test[currentSectionIndex]?.questions[currentQuestionIndex]?.text }}</h4>
      <ng-container *ngIf="!reviewMode; else reviewBlock">
        <mat-radio-group [(ngModel)]="answers[currentSectionIndex][currentQuestionIndex]">
          <mat-radio-button *ngFor="let option of test[currentSectionIndex]?.questions[currentQuestionIndex]?.options" [value]="option">
            {{ option }}
          </mat-radio-button>
        </mat-radio-group>
      </ng-container>
      <ng-template #reviewBlock>
        <div *ngFor="let option of test[currentSectionIndex].questions[currentQuestionIndex].options">
          <span [ngClass]="{
            'text-success': option === test[currentSectionIndex].questions[currentQuestionIndex].answer,
            'text-danger': option === answers[currentSectionIndex][currentQuestionIndex] && option !== test[currentSectionIndex].questions[currentQuestionIndex].answer
          }">
            <mat-icon *ngIf="option === answers[currentSectionIndex][currentQuestionIndex] && option === test[currentSectionIndex].questions[currentQuestionIndex].answer" style="font-size: 18px; vertical-align: middle; color: green;">check_circle</mat-icon>
            <mat-icon *ngIf="option === answers[currentSectionIndex][currentQuestionIndex] && option !== test[currentSectionIndex].questions[currentQuestionIndex].answer" style="font-size: 18px; vertical-align: middle; color: red;">cancel</mat-icon>
            <mat-icon *ngIf="option !== answers[currentSectionIndex][currentQuestionIndex] && option === test[currentSectionIndex].questions[currentQuestionIndex].answer" style="font-size: 18px; vertical-align: middle; color: green;">check_circle</mat-icon>
            {{ option }}
            <span *ngIf="option === answers[currentSectionIndex][currentQuestionIndex]"> (Your Answer)</span>
            <span *ngIf="option === test[currentSectionIndex].questions[currentQuestionIndex].answer"> (Correct Answer)</span>
          </span>
        </div>
        <div *ngIf="answers[currentSectionIndex][currentQuestionIndex]">
          <span [ngClass]="{'text-success': answers[currentSectionIndex][currentQuestionIndex] === test[currentSectionIndex].questions[currentQuestionIndex].answer, 'text-danger': answers[currentSectionIndex][currentQuestionIndex] !== test[currentSectionIndex].questions[currentQuestionIndex].answer}">
            <b>
              {{ answers[currentSectionIndex][currentQuestionIndex] === test[currentSectionIndex].questions[currentQuestionIndex].answer ? 'Correct Answer' : 'Wrong Answer' }}
            </b>
          </span>
        </div>
        <!-- Remove debug output after validation -->
      </ng-template>
    </div>
    <div class="mt-3 d-flex justify-content-between align-items-center" *ngIf="!reviewMode">
      <div>
        <button class="btn btn-secondary me-2" (click)="markForReviewAndNext()"
          [disabled]="currentQuestionIndex === test[currentSectionIndex].questions.length - 1">
          Mark for Review & Next
        </button>
        <button class="btn btn-warning me-2" (click)="clearResponse()">Clear Response</button>
      </div>
      <button class="btn btn-primary ms-auto" style="min-width: 140px;" (click)="saveAndNext()"
        [disabled]="currentQuestionIndex === test[currentSectionIndex].questions.length - 1">Save & Next</button>
    </div>
  </div>
  <div class="question-nav-fixed">
    <div class="question-nav-header">
      <div class="question-nav-status">
        <span><span class="legend answered"></span> Answered</span>
        <span><span class="legend marked"></span> Marked</span>
        <span><span class="legend marked-answered"></span> Marked & Answered</span>
        <span><span class="legend not-visited"></span> Not Visited</span>
        <span><span class="legend not-answered"></span> Not Answered</span>
      </div>
    </div>
    <div class="question-nav-circles flex-wrap">
      <ng-container *ngFor="let q of test[currentSectionIndex].questions; let idx = index">
        <button class="question-circle"
          (click)="navigate(idx)"
          [ngClass]="getNavStatus(currentSectionIndex, idx)">
          {{ idx + 1 }}
        </button>
      </ng-container>
    </div>
    <div class="question-nav-submit" style="margin-top: 1.5rem; width: 100%; text-align: center;" *ngIf="!reviewMode">
      <button class="btn btn-danger" (click)="submit()" style="width: 90%; max-width: 220px;">Submit Test</button>
    </div>
  </div>
</div>
<div *ngIf="!test || !test.length">
  <h2>No test loaded. Please select a test from the list.</h2>
</div>


<!-- Section navigation bar for live test -->
